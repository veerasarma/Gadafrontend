# =========================
# 1) Long caching for images, fonts, static assets
# =========================
<IfModule mod_expires.c>
  ExpiresActive On
  # Default safety
  ExpiresDefault "access plus 7 days"

  # Images: cache for a year
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/jpg  "access plus 1 year"
  ExpiresByType image/png  "access plus 1 year"
  ExpiresByType image/gif  "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/avif "access plus 1 year"

  # Fonts
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff  "access plus 1 year"

  # CSS/JS
  ExpiresByType text/css "access plus 7 days"
  ExpiresByType application/javascript "access plus 7 days"
</IfModule>

<IfModule mod_headers.c>
  # Strong cache + immutable for hashed/unique filenames (your uploads use unique names)
  <FilesMatch "\.(?:avif|webp|jpe?g|png|gif|woff2?)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  <FilesMatch "\.(?:css|js)$">
    Header set Cache-Control "public, max-age=604800"
  </FilesMatch>
</IfModule>

# =========================
# 2) Gzip/Brotli for text (images don’t gzip)
# =========================
<IfModule mod_brotli.c>
  BrotliCompressionQuality 5
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>

# =========================
# 3) Serve .webp automatically if browser supports it
#    (Upload a .webp alongside .jpg/.png with the same basename)
# =========================
<IfModule mod_rewrite.c>
  RewriteEngine On

  # If request is for .jpg/.jpeg/.png and a .webp of the same name exists…
  RewriteCond %{REQUEST_FILENAME} \.(jpe?g|png)$ [NC]
  RewriteCond %{REQUEST_FILENAME}.webp -f
  RewriteCond %{HTTP_ACCEPT} image/webp
  RewriteRule ^(.+)\.(jpe?g|png)$ $1.webp [T=image/webp,E=accept:1,L]
</IfModule>

<IfModule mod_mime.c>
  AddType image/webp .webp
</IfModule>

# Ensure caches split by Accept header (so webp/non-webp aren’t mixed)
<IfModule mod_headers.c>
  Header append Vary Accept env=REDIRECT_accept
</IfModule>

# =========================
# 4) Optional: fallback placeholder for missing images
# =========================
# Uncomment and set a real placeholder path if you want to avoid broken images
# <IfModule mod_rewrite.c>
#   RewriteCond %{REQUEST_FILENAME} !-f
#   RewriteRule \.(?:jpe?g|png|gif)$ /img/placeholder.jpg [L]
# </IfModule>
